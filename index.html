<!DOCTYPE html>
<html>
  <head>
    <link rel="icon" type="image/png" href="whiteboard.png">
    <title>Drawing board</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
    <style type='text/css'>
    body{
        padding-top: 10px;
        padding-bottom: 10px;
        padding-left: 10px;
        padding-right: 10px;

    }
    #headpad{
        padding-left: 5%;
    }
        #sheet {
            border:1px solid black;
        }
    </style>
  </head>
  <body>
    <div class="columns is-variable is-1-mobile is-0-tablet is-3-desktop is-8-widescreen is-2-fullhd">
        <div class="column is-1">
            <figure class="image is-128x128">
                <img src="whiteboard.png">
            </figure>
        </div>
        <div class="column" id="headpad">
        <h1 class="title">A hacked-up white board <span></span></h1>
        <h2 class="subtitle">Draw and save as image/jpeg</h2>
        </div>
    </div>
      
    
    <div class="columns is-variable is-1-mobile is-0-tablet is-3-desktop is-8-widescreen is-2-fullhd">
        <div class="column">
            <input class="input is-rounded" type="text" id="wid" placeholder="Enter Canvas Width">
          </div>
          <div class="column">
            <input class="input is-rounded" type="text" id="hgt" placeholder="Enter Canvas Height">
          </div>
      <div class="column">
        <button class="button is-primary is-focused" onclick="canvasize()" type="button">Resize</button>
      </div>
        <div class="column">
        <label for="favcolor">Select your brush color:</label>
        <input type="color" id="favcolor" name="favcolor" value="#33CC99">
        </div>
        <div class="column">
            <button class="button is-primary is-focused" onclick="brushcolor()" type="button">Submit brush color</button>
        </div>
    </div>
    
    <div class="columns is-variable is-1-mobile is-0-tablet is-3-desktop is-8-widescreen is-2-fullhd">
        <div class="column">
        <canvas id="sheet" width="1300" height="475"></canvas>
        </div>
    </div>
    <div class="columns is-variable is-1-mobile is-0-tablet is-3-desktop is-8-widescreen is-2-fullhd">
        <div class="column">
            <button class="button is-success is-focused" id='btn-download'>Download Canvas Image</button>
        </div>
    </div>
    
    
    <script type='text/javascript'>
/*jslint browser:true */
"use strict";
var context = document.getElementById('sheet').getContext("2d");
var canvas = document.getElementById('sheet');
context = canvas.getContext("2d");
context.fillStyle = "#FF0000";
context.strokeStyle = "#000000";
context.lineJoin = "round";
context.lineWidth = 5;

var clickX = [];
var clickY = [];
var clickDrag = [];
var paint;

/**
 * Add information where the user clicked at.
 * @param {number} x
 * @param {number} y
 * @return {boolean} dragging
 */
function addClick(x, y, dragging) {
    clickX.push(x);
    clickY.push(y);
    clickDrag.push(dragging);
}

/**
 * Redraw the complete canvas.
 */
function redraw() {
    // Clears the canvas
    context.clearRect(0, 0, context.canvas.width, context.canvas.height);

    for (var i = 0; i < clickX.length; i += 1) {
        if (!clickDrag[i] && i == 0) {
            context.beginPath();
            context.moveTo(clickX[i], clickY[i]);
            context.stroke();
        } else if (!clickDrag[i] && i > 0) {
            context.closePath();

            context.beginPath();
            context.moveTo(clickX[i], clickY[i]);
            context.stroke();
        } else {
            context.lineTo(clickX[i], clickY[i]);
            context.stroke();
        }
    }
}

/**
 * Draw the newly added point.
 * @return {void}
 */
function drawNew() {
    var i = clickX.length - 1
    if (!clickDrag[i]) {
        if (clickX.length == 0) {
            context.beginPath();
            context.moveTo(clickX[i], clickY[i]);
            context.stroke();
        } else {
            context.closePath();

            context.beginPath();
            context.moveTo(clickX[i], clickY[i]);
            context.stroke();
        }
    } else {
        context.lineTo(clickX[i], clickY[i]);
        context.stroke();
    }
}

function mouseDownEventHandler(e) {
    paint = true;
    var x = e.pageX - canvas.offsetLeft;
    var y = e.pageY - canvas.offsetTop;
    if (paint) {
        addClick(x, y, false);
        drawNew();
    }
}

function touchstartEventHandler(e) {
    paint = true;
    if (paint) {
        addClick(e.touches[0].pageX - canvas.offsetLeft, e.touches[0].pageY - canvas.offsetTop, false);
        drawNew();
    }
}

function mouseUpEventHandler(e) {
    context.closePath();
    paint = false;
}

function mouseMoveEventHandler(e) {
    var x = e.pageX - canvas.offsetLeft;
    var y = e.pageY - canvas.offsetTop;
    if (paint) {
        addClick(x, y, true);
        drawNew();
    }
}

function touchMoveEventHandler(e) {
    if (paint) {
        addClick(e.touches[0].pageX - canvas.offsetLeft, e.touches[0].pageY - canvas.offsetTop, true);
        drawNew();
    }
}

function setUpHandler(isMouseandNotTouch, detectEvent) {
    removeRaceHandlers();
    if (isMouseandNotTouch) {
        canvas.addEventListener('mouseup', mouseUpEventHandler);
        canvas.addEventListener('mousemove', mouseMoveEventHandler);
        canvas.addEventListener('mousedown', mouseDownEventHandler);
        mouseDownEventHandler(detectEvent);
    } else {
        canvas.addEventListener('touchstart', touchstartEventHandler);
        canvas.addEventListener('touchmove', touchMoveEventHandler);
        canvas.addEventListener('touchend', mouseUpEventHandler);
        touchstartEventHandler(detectEvent);
    }
}

function mouseWins(e) {
    setUpHandler(true, e);
}

function touchWins(e) {
    setUpHandler(false, e);
}

function removeRaceHandlers() {
    canvas.removeEventListener('mousedown', mouseWins);
    canvas.removeEventListener('touchstart', touchWins);
}

canvas.addEventListener('mousedown', mouseWins);
canvas.addEventListener('touchstart', touchWins);
    </script>
    <script>
    document.getElementById('btn-download').addEventListener("click", function(e) {
    var canvas = document.querySelector('#sheet');
    //blw - making background white
    var imgData=context.getImageData(0,0,canvas.width,canvas.height);
    var data=imgData.data;
    for(var i=0;i<data.length;i+=4){
        if(data[i+3]<255){
            data[i]=255;
            data[i+1]=255;
            data[i+2]=255;
            data[i+3]=255;
        }
    }
    context.putImageData(imgData,0,0);
//abv - making background white
    var dataURL = canvas.toDataURL("image/jpeg", 0.1);

    downloadImage(dataURL, 'my-canvas.jpeg');
});

// Save | Download image
function downloadImage(data, filename = 'untitled.jpeg') {
    var a = document.createElement('a');
    a.href = data;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
}
    </script>
    <script>
    function canvasize() {
    var widthba = document.getElementById("wid").value;
    var heightba = document.getElementById("hgt").value;
    var sheetba = document.getElementById("sheet");
    sheetba.width = widthba;
    sheetba.height = heightba;
    }
    </script>
    <script>
        function brushcolor() {
        var canvasba = document.getElementById("sheet")
        contextba = canvasba.getContext("2d");
        var color_val = document.getElementById("favcolor").value;
        contextba.strokeStyle = color_val;
        }
        </script>
  </body>
</html>
